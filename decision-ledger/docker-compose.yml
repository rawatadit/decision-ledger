version: '3.8'

services:
  # DynamoDB Local for development
  dynamodb-local:
    image: amazon/dynamodb-local:latest
    container_name: decision-ledger-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"
    volumes:
      - dynamodb_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000/shell/ || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Initialize DynamoDB tables
  dynamodb-init:
    image: amazon/aws-cli:latest
    container_name: decision-ledger-dynamodb-init
    depends_on:
      dynamodb-local:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: local
      AWS_SECRET_ACCESS_KEY: local
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: /bin/sh
    command:
      - -c
      - |
        aws dynamodb create-table \
          --table-name decision-ledger \
          --attribute-definitions \
            AttributeName=PK,AttributeType=S \
            AttributeName=SK,AttributeType=S \
            AttributeName=user_id,AttributeType=S \
            AttributeName=project_id,AttributeType=S \
            AttributeName=gsi3_pk,AttributeType=S \
            AttributeName=created_at,AttributeType=S \
            AttributeName=supersedes_id,AttributeType=S \
          --key-schema \
            AttributeName=PK,KeyType=HASH \
            AttributeName=SK,KeyType=RANGE \
          --global-secondary-indexes \
            '[
              {
                "IndexName": "GSI1-UserProjects",
                "KeySchema": [{"AttributeName":"user_id","KeyType":"HASH"},{"AttributeName":"PK","KeyType":"RANGE"}],
                "Projection": {"ProjectionType":"ALL"}
              },
              {
                "IndexName": "GSI2-ProjectDecisions",
                "KeySchema": [{"AttributeName":"project_id","KeyType":"HASH"},{"AttributeName":"created_at","KeyType":"RANGE"}],
                "Projection": {"ProjectionType":"ALL"}
              },
              {
                "IndexName": "GSI3-StatusFilter",
                "KeySchema": [{"AttributeName":"gsi3_pk","KeyType":"HASH"},{"AttributeName":"created_at","KeyType":"RANGE"}],
                "Projection": {"ProjectionType":"ALL"}
              },
              {
                "IndexName": "GSI4-Supersedes",
                "KeySchema": [{"AttributeName":"supersedes_id","KeyType":"HASH"}],
                "Projection": {"ProjectionType":"KEYS_ONLY"}
              }
            ]' \
          --billing-mode PAY_PER_REQUEST \
          --endpoint-url http://dynamodb-local:8000 \
        || echo "Table may already exist, continuing..."

  # LocalStack (optional - for full AWS emulation including SES, Secrets Manager)
  localstack:
    image: localstack/localstack:latest
    container_name: decision-ledger-localstack
    ports:
      - "4566:4566"
    environment:
      SERVICES: dynamodb,secretsmanager,ses,lambda
      DEBUG: 0
      DATA_DIR: /var/lib/localstack/data
    volumes:
      - localstack_data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    profiles:
      - localstack  # Only starts with: docker-compose --profile localstack up

volumes:
  dynamodb_data:
  localstack_data:
